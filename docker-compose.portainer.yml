version: '3.8'

# ============================================
# SITNOVA - Backend Stack for Portainer
# Usa IntegratecNet y Traefik existentes
# ============================================

services:
  # ============================================
  # BACKEND - FastAPI + LangGraph
  # ============================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    networks:
      - IntegratecNet
    environment:
      # General
      - ENVIRONMENT=production
      - DEBUG=false
      - LOG_LEVEL=WARNING

      # Redis - usa el Redis de Evolution
      - REDIS_HOST=evolution_redis
      - REDIS_PORT=6379

      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}

      # LLM
      - LLM_PROVIDER=google
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - LLM_MODEL=gemini-2.0-flash-exp

      # Ultravox
      - ULTRAVOX_API_KEY=${ULTRAVOX_API_KEY}

      # Evolution API existente
      - EVOLUTION_API_URL=https://devevoapi.integratec-ia.com
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}

      # Security
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=["https://sitnova.integratec-ia.com","https://sitnova-javierd009s-projects.vercel.app"]

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 512M
      labels:
        - traefik.enable=true
        - traefik.http.routers.sitnova-api.rule=Host(`api.sitnova.integratec-ia.com`)
        - traefik.http.routers.sitnova-api.entrypoints=websecure
        - traefik.http.routers.sitnova-api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.sitnova-api.service=sitnova-api
        - traefik.http.services.sitnova-api.loadbalancer.server.port=8000
        - traefik.http.services.sitnova-api.loadbalancer.passHostHeader=true

networks:
  IntegratecNet:
    external: true
    name: IntegratecNet
